---
import benchmarkData from "../data/benchmark-results.json";

interface ProviderResult {
  provider: string;
  summary: { ttiMs: { min: number; max: number; median: number; avg: number } };
  skipped?: boolean;
  skipReason?: string;
  iterations?: Array<{ ttiMs: number; error?: string }>;
}

const results = benchmarkData.results as ProviderResult[];
const timestamp = new Date(benchmarkData.timestamp).toLocaleDateString("en-US", {
  year: "numeric",
  month: "long",
  day: "numeric",
});

// Separate active vs skipped/failed, sort active by median TTI
const active = results
  .filter((r) => !r.skipped && r.summary.ttiMs.median > 0)
  .sort((a, b) => a.summary.ttiMs.median - b.summary.ttiMs.median);

const inactive = results.filter((r) => r.skipped || r.summary.ttiMs.median === 0);

const maxTti = Math.max(...active.map((r) => r.summary.ttiMs.max));

function formatSeconds(ms: number): string {
  return (ms / 1000).toFixed(1) + "s";
}

function barWidth(ms: number): number {
  return Math.max((ms / maxTti) * 100, 2);
}

function successCount(r: ProviderResult): string {
  if (!r.iterations || r.iterations.length === 0) return "";
  const ok = r.iterations.filter((i) => !i.error).length;
  return `${ok}/${r.iterations.length}`;
}

const providerGradient = "from-gray-900 to-gray-700 dark:from-white dark:to-gray-300";

const providerLogos: Record<string, string> = {
  e2b: "/E2B-logo-light.svg",
  vercel: "/Vercel_Logo_L.svg",
  blaxel: "/blaxel-logo-light.svg",
  modal: "/modal-logo-light.svg",
  daytona: "/daytona-logo-light.svg",
  namespace: "/namespace-logo-light.svg",
  railway: "/railway-light.svg",
  render: "/render-logo-light.svg",
};

---

<div class="relative isolate bg-transparent dark:bg-transparent py-4">
  <!-- Header -->
  <div class="border-b border-gray-200 dark:border-b-gray-700 py-16">
    <div class="mx-6">
      <div class="mx-auto max-w-4xl text-center">
        <div class="mb-8 mx-auto">
          <span class="inline-flex items-center bg-emerald-600/10 dark:bg-emerald-900/50 px-4 py-1.5 text-sm font-semibold text-emerald-800 dark:text-white ring-1 ring-inset ring-emerald-600/10 rounded-xs">
            Leaderboard
          </span>
        </div>
        <p class="mt-8 text-balance text-5xl font-semibold tracking-tight text-gray-900 dark:text-white sm:text-6xl">
          Sandbox Provider Comparison: Time to Interactive
        </p>
      </div>
      <p class="mx-auto mt-6 max-w-2xl text-pretty text-center text-lg font-medium text-gray-600 dark:text-gray-400 sm:text-xl/8">
        How fast can ComputeSDK create a sandbox and successfully execute a command on each sandbox provider.
      </p>
      <p class="mx-auto mt-3 max-w-2xl text-center text-sm text-gray-400 dark:text-gray-500">
        Last run: {timestamp}
      </p>
    </div>
  </div>

  <!-- Chart -->
  <div class="mx-auto max-w-4xl px-6 py-10">
    <div class="space-y-3">
      {active.map((r, i) => {
        const logo = providerLogos[r.provider];
        const pct = barWidth(r.summary.ttiMs.median);
        return (
          <div class="relative flex items-center gap-4 rounded-xl px-4 py-3">
            <div class="w-6 shrink-0 text-center">
              <span class="text-sm font-mono text-gray-400 dark:text-gray-500">{i + 1}</span>
            </div>

            <div class="w-24 shrink-0 flex items-center justify-start h-6">
              {logo ? (
                <img
                  src={logo}
                  alt={`${r.provider} logo`}
                  class="max-w-[90px] w-auto h-auto object-contain object-left dark:invert"
                />
              ) : (
                <span class="text-sm font-semibold text-gray-900 dark:text-white capitalize">{r.provider}</span>
              )}
            </div>

            <div class="flex-1 min-w-0">
              <div class="relative w-full h-7 bg-gray-100 dark:bg-gray-800/60 rounded-md overflow-hidden">
                <div
                  class={`absolute inset-y-0 left-0 bg-linear-to-r ${providerGradient} rounded-md transition-all duration-700 ease-out`}
                  style={`width: ${pct}%`}
                />
                <div class="absolute inset-0 flex items-center">
                    <span class="text-xs font-mono font-semibold text-gray-600 dark:text-gray-300" style={`margin-left: calc(${pct}% + 8px)`}>
                      {formatSeconds(r.summary.ttiMs.median)}
                    </span>
                </div>
              </div>
            </div>
          </div>
        );
      })}
    </div>

    <div class="mt-6 flex items-center justify-between text-xs text-gray-400 dark:text-gray-500 px-4">
      <span>0s</span>
      <div class="flex-1 mx-3 border-t border-dashed border-gray-200 dark:border-gray-700" />
      <span>{formatSeconds(maxTti)}</span>
    </div>
  </div>

  <!-- Details Table -->
  <div class="mx-auto max-w-4xl px-6 pb-16 flex flex-col items-center">
    <div class="overflow-hidden rounded-xl ring-1 ring-gray-200 dark:ring-gray-700">
      <table class="divide-y divide-gray-200 dark:divide-gray-700">
        <thead class="bg-gray-50 dark:bg-gray-800/50 w-full">
          <tr>
            <th class="px-8 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Provider</th>
            <th class="px-8 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Median</th>
            <th class="px-8 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Min</th>
            <th class="px-8 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Max</th>
            <th class="px-8 py-3 text-center text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">Runs</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200 dark:divide-gray-700 bg-white dark:bg-transparent">
          {active.map((r) => (
            <tr>
              <td class="px-8 py-4 text-sm text-center font-medium text-gray-900 dark:text-white capitalize">{r.provider}</td>
              <td class="px-8 py-4 text-sm text-center font-mono text-gray-600 dark:text-gray-300">{formatSeconds(r.summary.ttiMs.median)}</td>
              <td class="px-8 py-4 text-sm text-center font-mono text-gray-400 dark:text-gray-500">{formatSeconds(r.summary.ttiMs.min)}</td>
              <td class="px-8 py-4 text-sm text-center font-mono text-gray-400 dark:text-gray-500">{formatSeconds(r.summary.ttiMs.max)}</td>
              <td class="px-8 py-4 text-sm text-center text-gray-400 dark:text-gray-500">{successCount(r)}</td>
            </tr>
          ))}
          {inactive.map((r) => (
            <tr class="opacity-50">
              <td class="px-8 py-4 text-sm text-center font-medium text-gray-400 dark:text-gray-500 capitalize">{r.provider}</td>
              <td class="px-8 py-4 text-sm text-center text-gray-400 dark:text-gray-500" colspan="3">
                {r.skipped ? r.skipReason : "All iterations failed"}
              </td>
              <td class="px-8 py-4 text-sm text-center text-gray-400 dark:text-gray-500">
                {r.skipped ? "--" : successCount(r)}
              </td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>

    <p class="mt-6 text-center text-sm text-gray-400 dark:text-gray-500">
      TTI measures wall-clock time from <code class="text-xs bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded">compute.sandbox.create()</code> to first successful <code class="text-xs bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded">runCommand()</code>. Median of 3 iterations per provider.
    </p>
  </div>
</div>

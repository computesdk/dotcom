---
interface ProviderResult {
  provider: string;
  summary: { ttiMs: { min: number; max: number; median: number; avg: number } };
  skipped?: boolean;
  skipReason?: string;
  iterations?: Array<{ ttiMs: number; error?: string }>;
}

let results: ProviderResult[] = [];
let timestamp = "";
let fetchError = false;

try {
  const res = await fetch("https://raw.githubusercontent.com/computesdk/benchmarks/refs/heads/master/results/latest.json");
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const benchmarkData = await res.json();
  results = benchmarkData.results as ProviderResult[];
  timestamp = new Date(benchmarkData.timestamp).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
} catch (e) {
  fetchError = true;
}

const active = results
  .filter((r) => !r.skipped && r.summary.ttiMs.median > 0)
  .sort((a, b) => a.summary.ttiMs.median - b.summary.ttiMs.median);

const inactive = results.filter((r) => r.skipped || r.summary.ttiMs.median === 0);

function formatSeconds(ms: number): string {
  return (ms / 1000).toFixed(2) + "s";
}

function successCount(r: ProviderResult): string {
  if (!r.iterations || r.iterations.length === 0) return "";
  const ok = r.iterations.filter((i) => !i.error).length;
  return `${ok}/${r.iterations.length}`;
}

function successRatio(r: ProviderResult): number {
  if (!r.iterations || r.iterations.length === 0) return 0;
  const ok = r.iterations.filter((i) => !i.error).length;
  return ok / r.iterations.length;
}

function capitalize(s: string): string {
  if (s.toLowerCase() === "e2b") return "E2B";
  return s.charAt(0).toUpperCase() + s.slice(1);
}

const providerLogos: Record<string, string> = {
  e2b: "/E2B-logo-light.svg",
  vercel: "/Vercel_Logo_L.svg",
  blaxel: "/blaxel-logo-light.svg",
  modal: "/modal-logo-light.svg",
  daytona: "/daytona-logo-light.svg",
  namespace: "/namespace-logo-light.svg",
  railway: "/railway-light.svg",
  render: "/render-logo-light.svg",
  hopx: "/hopx-logo-light.svg",
  codesandbox: "/codesandbox-logo-light.svg",
  runloop: "/runloop-logo-light.svg",
};

import FAQAccordion from "./FAQAccordion.astro";
const benchmarksFAQs = [
  {
    question: "What is a sandbox?",
    answer: "A sandbox is anywhere you can run code in isolation. It could be a VM, bare metal, a container, anywhere with compute resources.",
  },
  {
    question: "What is Time to Interactive (TTI)?",
    answer: "TTI is the total elapsed time it takes for a sandbox provider to boot up a sandbox and run a terminal command inside the sandbox.",
  },
];
---

<div class="relative isolate bg-transparent dark:bg-transparent py-4">
  <!-- Header -->
  <div class="border-b border-gray-200 dark:border-b-gray-700 py-8">
    <div class="mx-6">
      <div class="mx-auto max-w-5xl text-center">
        <h1 class="mt-8 text-balance text-4xl font-semibold tracking-tight text-gray-900 dark:text-white sm:text-6xl">
          Sandbox Provider Benchmarks
        </h1>
      </div>
      <p class="mx-auto mt-6 max-w-2xl text-pretty text-center text-lg font-medium text-gray-600 dark:text-gray-400 sm:text-xl/8">
        Our leaderboard of common benchmarks for each of our sandbox providers.
      </p>
      <p id="benchmark-timestamp" class="mx-auto mt-3 max-w-2xl text-center text-sm text-gray-500 dark:text-gray-500">
        Last run: {timestamp}
      </p>
      <div class="mt-5 flex justify-center">
        <a
          href="https://github.com/computesdk/benchmarks"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm transition-colors hover:bg-gray-50 dark:hover:bg-gray-700"
        >
          <svg class="size-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12Z" /></svg>
          View on GitHub
        </a>
      </div>
    </div>
  </div>

  {fetchError ? (
    <div class="max-w-4xl mx-auto my-0 py-16 text-center">
      <p class="text-gray-500 dark:text-gray-400">Benchmark data is currently unavailable. Please check back later.</p>
    </div>
  ) : (
  <div class="max-w-4xl mx-auto my-0">
    <div class="w-full overflow-hidden bg-white dark:bg-gray-900/50 shadow-sm">
      <div class="overflow-x-auto">
        <table id="benchmark-table" class="w-full" data-build-timestamp={timestamp}>
          <thead>
            <tr class="border-b border-gray-200 dark:border-gray-700/60 bg-gray-50/80 dark:bg-gray-800/40">
              <th scope="col" class="w-[4%] py-3 pl-5 pr-2 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400">
                #
              </th>
              <th scope="col" class="w-[26%] px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 cursor-pointer select-none" data-sort="provider">
                <span class="group inline-flex items-center gap-1.5">
                  Provider
                  <span class="sort-icon opacity-0 transition-opacity group-hover:opacity-60" data-col="provider">
                    <svg class="size-3.5 sort-asc" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a.75.75 0 0 1 .53.22l4.25 4.25a.75.75 0 1 1-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 0 1-1.06-1.06l4.25-4.25A.75.75 0 0 1 10 5Z" clip-rule="evenodd" /></svg>
                    <svg class="size-3.5 sort-desc hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                  </span>
                </span>
              </th>
              <th scope="col" class="w-[22%] px-4 py-3 text-left text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 cursor-pointer select-none" data-sort="median">
                <span class="group inline-flex items-center gap-1.5">
                  Median TTI
                  <span class="sort-icon opacity-100 text-gray-700 dark:text-gray-300" data-col="median">
                    <svg class="size-3.5 sort-asc" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a.75.75 0 0 1 .53.22l4.25 4.25a.75.75 0 1 1-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 0 1-1.06-1.06l4.25-4.25A.75.75 0 0 1 10 5Z" clip-rule="evenodd" /></svg>
                    <svg class="size-3.5 sort-desc hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                  </span>
                </span>
              </th>
              <th scope="col" class="w-[12%] px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 cursor-pointer select-none" data-sort="min">
                <span class="group inline-flex items-center justify-end gap-1.5">
                  Min
                  <span class="sort-icon opacity-0 transition-opacity group-hover:opacity-60" data-col="min">
                    <svg class="size-3.5 sort-asc" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a.75.75 0 0 1 .53.22l4.25 4.25a.75.75 0 1 1-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 0 1-1.06-1.06l4.25-4.25A.75.75 0 0 1 10 5Z" clip-rule="evenodd" /></svg>
                    <svg class="size-3.5 sort-desc hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                  </span>
                </span>
              </th>
              <th scope="col" class="w-[12%] px-4 py-3 text-right text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 cursor-pointer select-none" data-sort="max">
                <span class="group inline-flex items-center justify-end gap-1.5">
                  Max
                  <span class="sort-icon opacity-0 transition-opacity group-hover:opacity-60" data-col="max">
                    <svg class="size-3.5 sort-asc" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a.75.75 0 0 1 .53.22l4.25 4.25a.75.75 0 1 1-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 0 1-1.06-1.06l4.25-4.25A.75.75 0 0 1 10 5Z" clip-rule="evenodd" /></svg>
                    <svg class="size-3.5 sort-desc hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                  </span>
                </span>
              </th>
              <th scope="col" class="w-[12%] py-3 pl-4 pr-5 text-right text-xs font-semibold uppercase tracking-wider text-gray-500 dark:text-gray-400 cursor-pointer select-none" data-sort="runs">
                <span class="group inline-flex items-center justify-end gap-1.5">
                  Runs
                  <span class="sort-icon opacity-0 transition-opacity group-hover:opacity-60" data-col="runs">
                    <svg class="size-3.5 sort-asc" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a.75.75 0 0 1 .53.22l4.25 4.25a.75.75 0 1 1-1.06 1.06L10 6.81l-3.72 3.72a.75.75 0 0 1-1.06-1.06l4.25-4.25A.75.75 0 0 1 10 5Z" clip-rule="evenodd" /></svg>
                    <svg class="size-3.5 sort-desc hidden" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.22 8.22a.75.75 0 0 1 1.06 0L10 11.94l3.72-3.72a.75.75 0 1 1 1.06 1.06l-4.25 4.25a.75.75 0 0 1-1.06 0L5.22 9.28a.75.75 0 0 1 0-1.06Z" clip-rule="evenodd" /></svg>
                  </span>
                </span>
              </th>
            </tr>
          </thead>
          <tbody>
            {active.map((r, i) => {
              const logo = providerLogos[r.provider];
              const maxMedian = Math.max(...active.map(a => a.summary.ttiMs.median));
              const barPct = Math.round((r.summary.ttiMs.median / maxMedian) * 100);
              const isFirst = i === 0;
              return (
                <tr class={`group border-b border-gray-100 dark:border-gray-800/60 transition-colors hover:bg-gray-50/70 dark:hover:bg-gray-800/30 ${isFirst ? 'bg-emerald-50/40 dark:bg-emerald-950/10' : ''}`}>
                  <td class="whitespace-nowrap py-4 pl-5 pr-2 align-middle rank-cell">
                    <span class={`inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${isFirst ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-400' : 'text-gray-400 dark:text-gray-500'}`}>
                      {i + 1}
                    </span>
                  </td>
                  <td class="whitespace-nowrap p-2 align-middle" data-value={r.provider}>
                    <div class="flex items-center gap-3">
                      {logo ? (
                        <div class="shrink-0 w-20 flex items-center justify-center">
                          <img
                            src={logo}
                            alt={`${r.provider} logo`}
                            class="w-auto h-8 object-contain dark:invert"
                          />
                        </div>
                      ) : (
                        <div class="shrink-0 w-20 rounded-md bg-gray-100 dark:bg-gray-800" />
                      )}
                    </div>
                  </td>
                  <td class="px-4 py-4 align-middle" data-value={r.summary.ttiMs.median}>
                    <div class="flex items-center gap-3">
                      <span class="shrink-0 w-14 text-sm font-mono font-bold tabular-nums text-gray-900 dark:text-white">
                        {formatSeconds(r.summary.ttiMs.median)}
                      </span>
                      <div class="flex-1 h-2 rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden">
                        <div
                          class={`h-full rounded-full transition-all ${isFirst ? 'bg-emerald-500 dark:bg-emerald-400' : 'bg-gray-300 dark:bg-gray-600'}`}
                          style={`width: ${barPct}%`}
                        />
                      </div>
                    </div>
                  </td>
                  <td class="whitespace-nowrap px-4 py-4 align-middle text-right text-sm font-mono tabular-nums text-gray-500 dark:text-gray-400" data-value={r.summary.ttiMs.min}>
                    {formatSeconds(r.summary.ttiMs.min)}
                  </td>
                  <td class="whitespace-nowrap px-4 py-4 align-middle text-right text-sm font-mono tabular-nums text-gray-500 dark:text-gray-400" data-value={r.summary.ttiMs.max}>
                    {formatSeconds(r.summary.ttiMs.max)}
                  </td>
                  <td class="whitespace-nowrap py-4 pl-4 pr-5 align-middle text-right" data-value={successRatio(r)}>
                    <span class="text-sm font-mono tabular-nums text-gray-500 dark:text-gray-400">{successCount(r)}</span>
                  </td>
                </tr>
              );
            })}
            {inactive.map((r) => (
              <tr class="border-b border-gray-100 dark:border-gray-800/60 opacity-40">
                <td class="whitespace-nowrap py-4 pl-5 pr-2 rank-cell">
                  <span class="inline-flex items-center justify-center w-6 h-6 text-xs text-gray-400 dark:text-gray-500">--</span>
                </td>
                <td class="whitespace-nowrap px-4 py-4" data-value={"zzz_" + r.provider}>
                  <div class="flex items-center gap-3">
                    <div class="shrink-0 w-10 h-10 rounded-md bg-gray-100 dark:bg-gray-800" />
                    <span class="text-sm font-semibold text-gray-400 dark:text-gray-500">{capitalize(r.provider)}</span>
                  </div>
                </td>
                <td class="px-4 py-4 text-sm text-gray-400 dark:text-gray-500" data-value="Infinity" colspan="3">
                  {r.skipped ? r.skipReason : "All iterations failed"}
                </td>
                <td class="whitespace-nowrap py-4 pl-4 pr-5 text-right text-sm font-mono tabular-nums text-gray-400 dark:text-gray-500" data-value="0">
                  {r.skipped ? "--" : successCount(r)}
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>
    </div>

    <p class="mt-5 text-center text-sm text-gray-600 dark:text-gray-400">
      TTI measures wall-clock time from <code class="bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-[11px]">compute.sandbox.create()</code> to first successful <code class="bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-[11px]">runCommand()</code>. Median of 10 iterations per provider.
    </p>
    <p class="mt-3 text-center text-sm text-gray-600 dark:text-gray-400">
      Want to see a provider added? <a href="https://x.com/computesdk" target="_blank" rel="noopener noreferrer" class="underline underline-offset-2 hover:text-gray-900 dark:hover:text-white transition-colors">Let us know on X</a>.
    </p>
  </div>
  )}

  <FAQAccordion title="Sandbox Benchmarks FAQs" items={benchmarksFAQs} />  
</div>

<script>
  const table = document.getElementById('benchmark-table');
  if (table) {
    const headers = table.querySelectorAll('th[data-sort]');
    let currentSort = 'median';
    let currentDir = 'asc';

    headers.forEach(th => {
      th.addEventListener('click', () => {
        const col = th.getAttribute('data-sort');
        if (!col) return;

        if (currentSort === col) {
          currentDir = currentDir === 'asc' ? 'desc' : 'asc';
        } else {
          currentSort = col;
          currentDir = 'asc';
        }

        sortTable(col, currentDir);
        updateSortIcons(col, currentDir);
      });
    });

    function getColIndex(col: string): number {
      switch (col) {
        case 'provider': return 1;
        case 'median': return 2;
        case 'min': return 3;
        case 'max': return 4;
        case 'runs': return 5;
        default: return 2;
      }
    }

    function sortTable(col: string, dir: string) {
      const tbody = table!.querySelector('tbody');
      if (!tbody) return;

      const rows = Array.from(tbody.querySelectorAll('tr'));
      const activeRows = rows.filter(r => !r.classList.contains('opacity-40'));
      const inactiveRows = rows.filter(r => r.classList.contains('opacity-40'));

      const colIndex = getColIndex(col);

      activeRows.sort((a, b) => {
        const cellA = a.children[colIndex] as HTMLElement;
        const cellB = b.children[colIndex] as HTMLElement;
        const valA = cellA?.getAttribute('data-value') || '';
        const valB = cellB?.getAttribute('data-value') || '';

        let cmp: number;
        if (col === 'provider') {
          cmp = valA.localeCompare(valB);
        } else {
          cmp = parseFloat(valA) - parseFloat(valB);
        }

        return dir === 'asc' ? cmp : -cmp;
      });

      activeRows.forEach((row, i) => {
        const rankSpan = row.querySelector('.rank-cell span');
        if (rankSpan) rankSpan.textContent = String(i + 1);
      });

      [...activeRows, ...inactiveRows].forEach(row => tbody.appendChild(row));
    }

    function updateSortIcons(activeCol: string, dir: string) {
      table!.querySelectorAll('.sort-icon').forEach(icon => {
        const el = icon as HTMLElement;
        el.classList.remove('opacity-100', 'text-gray-700', 'dark:text-gray-300');
        el.classList.add('opacity-0');
      });

      const activeIcon = table!.querySelector(`.sort-icon[data-col="${activeCol}"]`) as HTMLElement;
      if (activeIcon) {
        activeIcon.classList.remove('opacity-0');
        activeIcon.classList.add('opacity-100', 'text-gray-700', 'dark:text-gray-300');

        const ascIcon = activeIcon.querySelector('.sort-asc') as HTMLElement;
        const descIcon = activeIcon.querySelector('.sort-desc') as HTMLElement;
        if (dir === 'asc') {
          ascIcon.classList.remove('hidden');
          descIcon.classList.add('hidden');
        } else {
          ascIcon.classList.add('hidden');
          descIcon.classList.remove('hidden');
        }
      }
    }
  }
</script>

<script>
  const BENCHMARK_URL = "https://raw.githubusercontent.com/computesdk/benchmarks/refs/heads/master/results/latest.json";

  const providerLogos: Record<string, string> = {
    e2b: "/E2B-logo-light.svg",
    vercel: "/Vercel_Logo_L.svg",
    blaxel: "/blaxel-logo-light.svg",
    modal: "/modal-logo-light.svg",
    daytona: "/daytona-logo-light.svg",
    namespace: "/namespace-logo-light.svg",
    railway: "/railway-light.svg",
    render: "/render-logo-light.svg",
    hopx: "/hopx-logo-light.svg",
    codesandbox: "/codesandbox-logo-light.svg",
    runloop: "/runloop-logo-light.svg",
  };

  interface ProviderResult {
    provider: string;
    summary: { ttiMs: { min: number; max: number; median: number; avg: number } };
    skipped?: boolean;
    skipReason?: string;
    iterations?: Array<{ ttiMs: number; error?: string }>;
  }

  function fmtSec(ms: number): string {
    return (ms / 1000).toFixed(2) + "s";
  }

  function runs(r: ProviderResult): string {
    if (!r.iterations || r.iterations.length === 0) return "";
    const ok = r.iterations.filter((i) => !i.error).length;
    return `${ok}/${r.iterations.length}`;
  }

  function ratio(r: ProviderResult): number {
    if (!r.iterations || r.iterations.length === 0) return 0;
    const ok = r.iterations.filter((i) => !i.error).length;
    return ok / r.iterations.length;
  }

  function cap(s: string): string {
    if (s.toLowerCase() === "e2b") return "E2B";
    return s.charAt(0).toUpperCase() + s.slice(1);
  }

  function buildActiveRow(r: ProviderResult, i: number, maxMedian: number): string {
    const logo = providerLogos[r.provider];
    const barPct = Math.round((r.summary.ttiMs.median / maxMedian) * 100);
    const isFirst = i === 0;
    const rowClass = `group border-b border-gray-100 dark:border-gray-800/60 transition-colors hover:bg-gray-50/70 dark:hover:bg-gray-800/30 ${isFirst ? 'bg-emerald-50/40 dark:bg-emerald-950/10' : ''}`;
    const rankClass = `inline-flex items-center justify-center w-6 h-6 rounded-full text-xs font-bold ${isFirst ? 'bg-emerald-100 text-emerald-700 dark:bg-emerald-900/40 dark:text-emerald-400' : 'text-gray-400 dark:text-gray-500'}`;
    const barClass = `h-full rounded-full transition-all ${isFirst ? 'bg-emerald-500 dark:bg-emerald-400' : 'bg-gray-300 dark:bg-gray-600'}`;
    const logoHtml = logo
      ? `<div class="shrink-0 w-20 flex items-center justify-center"><img src="${logo}" alt="${r.provider} logo" class="w-auto h-8 object-contain dark:invert" /></div>`
      : `<div class="shrink-0 w-20 rounded-md bg-gray-100 dark:bg-gray-800"></div>`;

    return `<tr class="${rowClass}">
      <td class="whitespace-nowrap py-4 pl-5 pr-2 align-middle rank-cell"><span class="${rankClass}">${i + 1}</span></td>
      <td class="whitespace-nowrap p-2 align-middle" data-value="${r.provider}"><div class="flex items-center gap-3">${logoHtml}</div></td>
      <td class="px-4 py-4 align-middle" data-value="${r.summary.ttiMs.median}"><div class="flex items-center gap-3"><span class="shrink-0 w-14 text-sm font-mono font-bold tabular-nums text-gray-900 dark:text-white">${fmtSec(r.summary.ttiMs.median)}</span><div class="flex-1 h-2 rounded-full bg-gray-100 dark:bg-gray-800 overflow-hidden"><div class="${barClass}" style="width: ${barPct}%"></div></div></div></td>
      <td class="whitespace-nowrap px-4 py-4 align-middle text-right text-sm font-mono tabular-nums text-gray-500 dark:text-gray-400" data-value="${r.summary.ttiMs.min}">${fmtSec(r.summary.ttiMs.min)}</td>
      <td class="whitespace-nowrap px-4 py-4 align-middle text-right text-sm font-mono tabular-nums text-gray-500 dark:text-gray-400" data-value="${r.summary.ttiMs.max}">${fmtSec(r.summary.ttiMs.max)}</td>
      <td class="whitespace-nowrap py-4 pl-4 pr-5 align-middle text-right" data-value="${ratio(r)}"><span class="text-sm font-mono tabular-nums text-gray-500 dark:text-gray-400">${runs(r)}</span></td>
    </tr>`;
  }

  function buildInactiveRow(r: ProviderResult): string {
    const reason = r.skipped ? (r.skipReason || 'Skipped') : "All iterations failed";
    const runsText = r.skipped ? "--" : runs(r);
    return `<tr class="border-b border-gray-100 dark:border-gray-800/60 opacity-40">
      <td class="whitespace-nowrap py-4 pl-5 pr-2 rank-cell"><span class="inline-flex items-center justify-center w-6 h-6 text-xs text-gray-400 dark:text-gray-500">--</span></td>
      <td class="whitespace-nowrap px-4 py-4" data-value="zzz_${r.provider}"><div class="flex items-center gap-3"><div class="shrink-0 w-10 h-10 rounded-md bg-gray-100 dark:bg-gray-800"></div><span class="text-sm font-semibold text-gray-400 dark:text-gray-500">${cap(r.provider)}</span></div></td>
      <td class="px-4 py-4 text-sm text-gray-400 dark:text-gray-500" data-value="Infinity" colspan="3">${reason}</td>
      <td class="whitespace-nowrap py-4 pl-4 pr-5 text-right text-sm font-mono tabular-nums text-gray-400 dark:text-gray-500" data-value="0">${runsText}</td>
    </tr>`;
  }

  async function refreshBenchmarks() {
    const table = document.getElementById('benchmark-table');
    if (!table) return;

    try {
      const res = await fetch(BENCHMARK_URL);
      if (!res.ok) return;
      const data = await res.json();

      const freshTimestamp = new Date(data.timestamp).toLocaleDateString("en-US", {
        year: "numeric",
        month: "long",
        day: "numeric",
      });

      const buildTimestamp = table.getAttribute('data-build-timestamp');
      if (buildTimestamp === freshTimestamp) return;

      const results: ProviderResult[] = data.results;
      const active = results
        .filter((r) => !r.skipped && r.summary.ttiMs.median > 0)
        .sort((a, b) => a.summary.ttiMs.median - b.summary.ttiMs.median);
      const inactive = results.filter((r) => r.skipped || r.summary.ttiMs.median === 0);
      const maxMedian = active.length > 0 ? Math.max(...active.map((a) => a.summary.ttiMs.median)) : 1;

      const tbody = table.querySelector('tbody');
      if (!tbody) return;

      const html = active.map((r, i) => buildActiveRow(r, i, maxMedian)).join('')
        + inactive.map((r) => buildInactiveRow(r)).join('');
      tbody.innerHTML = html;

      table.setAttribute('data-build-timestamp', freshTimestamp);

      const timestampEl = document.getElementById('benchmark-timestamp');
      if (timestampEl) timestampEl.textContent = `Last run: ${freshTimestamp}`;
    } catch {
      // Silently fail â€” build-time data remains displayed
    }
  }

  refreshBenchmarks();
</script>

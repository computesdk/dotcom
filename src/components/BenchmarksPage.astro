---
import FAQAccordion from "./FAQAccordion.astro";
import { BenchmarkChart } from "./BenchmarkChart";
import { BenchmarkTable } from "./BenchmarkTable";

interface ProviderResult {
  provider: string;
  summary: { ttiMs: { min: number; max: number; median: number; p95: number; p99: number; avg: number } };
  skipped?: boolean;
  skipReason?: string;
  iterations?: Array<{ ttiMs: number; error?: string }>;
}

interface HistoryDataPoint {
  date: string;
  [provider: string]: number | string;
}

let results: ProviderResult[] = [];
let timestamp = "";
let fetchError = false;
let historyData: HistoryDataPoint[] = [];
let chartProviders: string[] = [];

try {
  const res = await fetch("https://raw.githubusercontent.com/computesdk/benchmarks/refs/heads/master/results/latest.json");
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const benchmarkData = await res.json();
  results = benchmarkData.results as ProviderResult[];
  timestamp = new Date(benchmarkData.timestamp).toLocaleDateString("en-US", {
    year: "numeric",
    month: "long",
    day: "numeric",
  });
} catch (e) {
  fetchError = true;
}

try {
  const listRes = await fetch("https://api.github.com/repos/computesdk/benchmarks/contents/results");
  if (listRes.ok) {
    const files = (await listRes.json()) as Array<{ name: string; download_url: string }>;
    const jsonFiles = files
      .filter((f) => f.name.endsWith(".json") && f.name !== "latest.json" && f.name !== ".gitkeep")
      .sort((a, b) => a.name.localeCompare(b.name));

    const allProviders = new Set<string>();
    const cutoffDate = new Date("2026-02-21T00:00:00Z");
    const excludedProviders = new Set(["railway", "render"]);

    const historyPoints: HistoryDataPoint[] = [];
    for (const file of jsonFiles) {
      try {
        const fileRes = await fetch(file.download_url);
        if (!fileRes.ok) continue;
        const data = await fileRes.json();
        const ts = data.timestamp as string;
        if (new Date(ts) <= cutoffDate) continue;
        const dateLabel = new Date(ts).toLocaleDateString("en-US", { month: "short", day: "numeric" });
        const point: HistoryDataPoint = { date: dateLabel };
        for (const r of data.results as ProviderResult[]) {
          if (!r.skipped && r.summary.ttiMs.median > 0 && !excludedProviders.has(r.provider)) {
            point[r.provider] = Math.round(r.summary.ttiMs.median);
            allProviders.add(r.provider);
          }
        }
        historyPoints.push(point);
      } catch {
        continue;
      }
    }
    historyData = historyPoints;
    chartProviders = Array.from(allProviders);
  }
} catch {
  // Historical data fetch failed — chart will be hidden
}

const active = results
  .filter((r) => !r.skipped && r.summary.ttiMs.median > 0)
  .sort((a, b) => a.summary.ttiMs.median - b.summary.ttiMs.median);

const inactive = results.filter((r) => r.skipped || r.summary.ttiMs.median === 0);

const providerLogos: Record<string, string> = {
  e2b: "/E2B-logo-light.svg",
  vercel: "/Vercel_Logo_L.svg",
  blaxel: "/blaxel-logo-light.svg",
  modal: "/modal-logo-light.svg",
  daytona: "/daytona-logo-light.svg",
  namespace: "/namespace-logo-light.svg",
  railway: "/railway-light.svg",
  render: "/render-logo-light.svg",
  hopx: "/hopx-logo-light.svg",
  codesandbox: "/codesandbox-logo-light.svg",
  runloop: "/runloop-logo-light.svg",
};

const benchmarksFAQs = [
  {
    question: "What is a sandbox?",
    answer: "A sandbox is anywhere you can run code in isolation. It could be a VM, bare metal, a container, anywhere with compute resources.",
  },
  {
    question: "What is Time to Interactive (TTI)?",
    answer: "TTI is the total elapsed time it takes for a sandbox provider to boot up a sandbox and run a terminal command inside the sandbox.",
  },
  {
    question: "Why use median instead of average?",
    answer: "The average can be easily skewed by a single extreme outlier. The median provides a more accurate representation of the typical performance most users will experience.",
  },
  {
    question: "What does P95 mean?",
    answer: "P95 stands for the 95th percentile. 95% of iterations completed at or below this time. Tells you the 'typical worst case' — what a user experiences on a bad-but-not-extreme run.",
  },
  {
    question: "What does P99 mean?",
    answer: "P99 stands for the 99th percentile. 99% of iterations completed at or below this time. It highlights the tail latency (the rare outlier spikes). With 100 iterations, this is the 99th value (second-worst)",
  },
];
---

<div class="relative isolate bg-transparent dark:bg-transparent py-4">
  <!-- Header -->
  <div class="border-b border-gray-200 dark:border-b-gray-700 py-4">
    <div class="mx-6">
      <div class="mx-auto max-w-5xl text-center">
        <h1 class="text-balance text-2xl font-semibold tracking-tight text-gray-900 dark:text-white sm:text-6xl">
          Sandbox Benchmarks
        </h1>
      </div>
      <p class="mx-auto mt-2 max-w-2xl text-pretty text-center text-lg font-medium text-gray-600 dark:text-gray-400">
        A leaderboard of common benchmarks for each of our sandbox providers.
      </p>
      <p id="benchmark-timestamp" class="mx-auto mt-2 max-w-2xl text-center text-sm text-gray-500 dark:text-gray-500">
        Last run: {timestamp}
      </p>
      <div class="mt-2 flex justify-center">
        <a
          href="https://github.com/computesdk/benchmarks"
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 rounded-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 shadow-sm transition-colors hover:bg-gray-50 dark:hover:bg-gray-700"
        >
          <svg class="size-5" fill="currentColor" viewBox="0 0 24 24"><path d="M12 0C5.37 0 0 5.37 0 12c0 5.31 3.435 9.795 8.205 11.385.6.105.825-.255.825-.57 0-.285-.015-1.23-.015-2.235-3.015.555-3.795-.735-4.035-1.41-.135-.345-.72-1.41-1.23-1.695-.42-.225-1.02-.78-.015-.795.945-.015 1.62.87 1.845 1.23 1.08 1.815 2.805 1.305 3.495.99.105-.78.42-1.305.765-1.605-2.67-.3-5.46-1.335-5.46-5.925 0-1.305.465-2.385 1.23-3.225-.12-.3-.54-1.53.12-3.18 0 0 1.005-.315 3.3 1.23.96-.27 1.98-.405 3-.405s2.04.135 3 .405c2.295-1.56 3.3-1.23 3.3-1.23.66 1.65.24 2.88.12 3.18.765.84 1.23 1.905 1.23 3.225 0 4.605-2.805 5.625-5.475 5.925.435.375.81 1.095.81 2.22 0 1.605-.015 2.895-.015 3.3 0 .315.225.69.825.57A12.02 12.02 0 0 0 24 12c0-6.63-5.37-12-12-12Z" /></svg>
          View on GitHub
        </a>
      </div>
    </div>
  </div>

  {fetchError ? (
    <div class="max-w-4xl mx-auto my-0 py-16 text-center">
      <p class="text-gray-500 dark:text-gray-400">Benchmark data is currently unavailable. Please check back later.</p>
    </div>
  ) : (
  <div class="max-w-6xl mx-auto my-0">
    <BenchmarkTable
      client:load
      active={active}
      inactive={inactive}
      providerLogos={providerLogos}
    />

    {historyData.length > 0 && (
      <div class="py-8 px-4">
        <BenchmarkChart
          client:visible
          historyData={historyData}
          providers={chartProviders}
        />
      </div>
    )}

    <p class="mt-5 text-center text-sm text-gray-600 dark:text-gray-400">
      TTI measures wall-clock time from <code class="bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-[11px]">compute.sandbox.create()</code> to first successful <code class="bg-gray-100 dark:bg-gray-800 px-1.5 py-0.5 rounded text-[11px]">runCommand()</code>. Median of 100 iterations per provider.
    </p>
    <p class="mt-3 text-center text-sm text-gray-600 dark:text-gray-400">
      Want to see a provider added? <a href="https://x.com/computesdk" target="_blank" rel="noopener noreferrer" class="underline underline-offset-2 hover:text-gray-900 dark:hover:text-white transition-colors">Let us know on X</a>.
    </p>
  </div>
  )}

  <FAQAccordion title="Sandbox Benchmarks FAQs" items={benchmarksFAQs} />  
</div>
